<!DOCTYPE html>
<head>
<meta content="text/html;charset=utf-8" http-equiv="Content-Type">
<meta content="utf-8" http-equiv="encoding">
<!-- Everything from http://threejs.org/examples/webgl_loader_stl.html -->
<script src="three.min.js"></script>
<script src="Detector.js"></script>
<script src="TrackballControls.js"></script>
<script src="OrbitControls.js"></script>
</head>

<body style="margin:0;padding:0">

<script>
if (!Detector.webgl) Detector.addGetWebGLMessage();
var container;
var camera, cameraTarget, scene, renderer;
var windowHalfX = 0;
var windowHalfY = 0;
init();
animate();

function init() {
  container = document.createElement('div');
  document.body.appendChild(container);
  camera = new THREE.PerspectiveCamera(40, window.innerWidth / window.innerHeight, 1e-1, 1e4);
  camera.position.set(0.1, 1, 0.8);
  cameraTarget = new THREE.Vector3(0, 0, 0);
  scene = new THREE.Scene();
  scene.fog = new THREE.Fog(0x000000, 20, 20);
  // ASCII file
  var path = "pisa/";
  var format = '.png';
  var urls = [
    path + 'px' + format, path + 'nx' + format,
    path + 'py' + format, path + 'ny' + format,
    path + 'pz' + format, path + 'nz' + format
  ];
  var textureCube = THREE.ImageUtils.loadTextureCube(urls);
  var loader = new THREE.JSONLoader();
  loader.load('./4-5.js', function(geometry) {
    var material = new THREE.MeshPhongMaterial({
      color: 0x000000,
      specular: 0xffffff,
      combine: THREE.MultiplyOperation,
      shininess: 5,
      shading: THREE.SmoothShading,
      reflectivity: 1,
      envMap: textureCube,
    })
    var mesh = new THREE.Mesh(geometry, material);
    mesh.position.set(0, 0, 0);
    mesh.scale.set(40, 40, 40);
    scene.add(mesh);
  });

  // Bottom Inlay Cover
  var loaderInlay = new THREE.JSONLoader();
  loaderInlay.load('./4-5-inlay.js', function(geometry) {
    var material = new THREE.MeshPhongMaterial({
      color: new THREE.Color(0x000000),
      specular: new THREE.Color(0x000000),
      shininess: 30,
      shading: THREE.SmoothShading,
      reflectivity: 1
    })
    var mesh = new THREE.Mesh(geometry, material);
    mesh.position.set(0, 0, 0);
    mesh.scale.set(40, 40, 40);
    mesh.rotation.set(3.142, 0, 0);
    scene.add(mesh);
  });

  // Top Inlay Cover
  var loaderInlay = new THREE.JSONLoader();
  loaderInlay.load('./inlayUV.js', function(geometry) {

/*
    var material = new THREE.MeshPhongMaterial({
      color: new THREE.Color(0xffffff),
      specular: new THREE.Color(0xffffff),
      shininess: 30,
      shading: THREE.SmoothShading,
      reflectivity: 1
    })
*/
   
    var material = new THREE.MeshPhongMaterial({ 
      color: new THREE.Color(0xd3d3d3),
      specular: new THREE.Color(0xffffff),
      shininess: 100,
      shading: THREE.SmoothShading,
      reflectivity: 100,
      ambient: new THREE.Color(0xffffff),
      map: THREE.ImageUtils.loadTexture('./inlayUV.png') 
    });

    var mesh = new THREE.Mesh(geometry, material);
    mesh.position.set(0, 0, 0);
    mesh.scale.set(40, 40, 40);
    scene.add(mesh);
  });

  // Lights
  addShadowedLight(5, -1, -3, 0xffffff, 2.35);
  addShadowedLight(0, 3, 0, 0xffffff, 1.35);
  addShadowedLight(5, -5, 30, 0xffffff, 3.5);

  // renderer
  renderer = Detector.webgl? new THREE.WebGLRenderer({antialias: true}): new THREE.CanvasRenderer();
  renderer.setSize(window.innerWidth, window.innerHeight);
  renderer.setClearColor(scene.fog.color, 1);
  renderer.setClearColorHex(0xffffff, 1);
  renderer.gammaInput = true;
  renderer.gammaOutput = true;
  renderer.shadowMapEnabled = true;
  renderer.shadowMapCullFace = THREE.CullFaceBack;
  container.appendChild(renderer.domElement);
  window.addEventListener('resize', onWindowResize, false);
  controls = new THREE.OrbitControls(camera);
  controls.damping = 0.2;
  controls.addEventListener('change', render);
}

function animate() {
  requestAnimationFrame(animate);
  controls.update();
  render();
}

function render() {
  renderer.render(scene, camera);
}

function addShadowedLight(x, y, z, color, intensity) {
  var directionalLight = new THREE.DirectionalLight(color, intensity);
  directionalLight.position.set(x, y, z)
  scene.add(directionalLight);
  directionalLight.castShadow = true;
  // directionalLight.shadowCameraVisible = true;
  var d = 1;
  directionalLight.shadowCameraLeft = -d;
  directionalLight.shadowCameraRight = d;
  directionalLight.shadowCameraTop = d;
  directionalLight.shadowCameraBottom = -d;
  directionalLight.shadowCameraNear = 1;
  directionalLight.shadowCameraFar = 4;
  directionalLight.shadowMapWidth = 1024;
  directionalLight.shadowMapHeight = 1024;
  directionalLight.shadowBias = -0.005;
  directionalLight.shadowDarkness = 0.25;
}

function onWindowResize() {
  windowHalfX = window.innerWidth / 2;
  windowHalfY = window.innerHeight / 2;
  camera.aspect = window.innerWidth / window.innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(window.innerWidth, window.innerHeight);
}
</script>

</body>
</html>
