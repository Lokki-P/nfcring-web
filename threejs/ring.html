<!DOCTYPE html>
<head>
<meta content="text/html;charset=utf-8" http-equiv="Content-Type">
<meta content="utf-8" http-equiv="encoding">
<meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
<!-- Everything from http://threejs.org/examples/webgl_loader_stl.html -->
<script src="three.min.js"></script>
<script src="Detector.js"></script>
<script src="TrackballControls.js"></script>
<script src="OrbitControls.js"></script>
</head>

<body style="margin:0;padding:0;width:100%;height:100%">
  <div id="ringRender" style="width:100%;height:100%"></div>
</body>
<script>
var sku = getURLParameter("sku");
// Example SKU: NTAG203-V1-NORMAL-T-B-W-12
if(!sku || sku == "null") alert("No SKU provided");

if (!Detector.webgl || sku == "null"){
  // If no WebGL don't even attempt, Canvas can't handle this task
  Detector.addGetWebGLMessage();
}else{
  var ringSize = sku.split("-")[6];
  ringSize = ringSize.replace(".","-");
  var topInlay = sku.split("-")[4];
  var bottomInlay = sku.split("-")[5];
  var container, camera, cameraTarget, scene, renderer;
  var windowHalfX = 0;
  var windowHalfY = 0;
  init();
  animate();
}

function init() {
  var container = document.getElementById("ringRender");
  camera = new THREE.PerspectiveCamera(40, window.innerWidth / window.innerHeight, 1e-1, 1e4);
  camera.position.set(1.2, 0.2, -1.2);
  cameraTarget = new THREE.Vector3(0, 0, 0);
  scene = new THREE.Scene();
  scene.fog = new THREE.Fog(0x000000, 20, 20);
  drawBlank(ringSize);
  drawInlay("top", topInlay);
  drawInlay("bottom", bottomInlay);

  // Lights
  addShadowedLight(5, -1, -3, 0xffffff, 2.35);
  addShadowedLight(0, 3, 0, 0xffffff, 1.35);
  addShadowedLight(5, -5, 30, 0xffffff, 2.5);

  // renderer
  renderer = Detector.webgl? new THREE.WebGLRenderer({antialias: true}): new THREE.CanvasRenderer();
  renderer.setSize(window.innerWidth, window.innerHeight);
  renderer.setClearColor(0xffffff, 1);
  renderer.gammaInput = true;
  renderer.gammaOutput = true;
  renderer.shadowMapEnabled = true;
  renderer.shadowMapCullFace = THREE.CullFaceBack;
  container.appendChild(renderer.domElement);
  window.addEventListener('resize', onWindowResize, false);
  controls = new THREE.OrbitControls(camera);
  controls.damping = 0.2;
  controls.addEventListener('change', render);
}

function animate() {
  requestAnimationFrame(animate);
  controls.update();
  render();
}

function render() {
  renderer.render(scene, camera);
}

function addShadowedLight(x, y, z, color, intensity) {
  var directionalLight = new THREE.DirectionalLight(color, intensity);
  directionalLight.position.set(x, y, z)
  scene.add(directionalLight);
  directionalLight.castShadow = true;
  // directionalLight.shadowCameraVisible = true;
  var d = 1;
  directionalLight.shadowCameraLeft = -d;
  directionalLight.shadowCameraRight = d;
  directionalLight.shadowCameraTop = d;
  directionalLight.shadowCameraBottom = -d;
  directionalLight.shadowCameraNear = 1;
  directionalLight.shadowCameraFar = 4;
  directionalLight.shadowMapWidth = 1024;
  directionalLight.shadowMapHeight = 1024;
  directionalLight.shadowBias = -0.005;
  directionalLight.shadowDarkness = 0.25;
}

function onWindowResize() {
  windowHalfX = window.innerWidth / 2;
  windowHalfY = window.innerHeight / 2;
  camera.aspect = window.innerWidth / window.innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(window.innerWidth, window.innerHeight);
}

function getURLParameter(name) {
  return decodeURIComponent(
    (RegExp('[?|&]'+name + '=' + '(.+?)(&|$)').exec(location.search)||[null,null])[1]
  );
}

function drawBlank(ringSize){
  // ASCII file
  var path = "pisa/";
  var format = '.png';
  var urls = [
    path + 'px' + format, path + 'nx' + format,
    path + 'py' + format, path + 'ny' + format,
    path + 'pz' + format, path + 'nz' + format
  ];
  var textureCube = THREE.ImageUtils.loadTextureCube(urls);

  var loader = new THREE.JSONLoader();
  // Ring Blank
  loader.load('./'+ringSize+'.js', function(geometry) {
    var material = new THREE.MeshPhongMaterial({
      color: 0xA9A9A9,
      specular: 0x000000,
      combine: THREE.MultiplyOperation,
      shininess: 5,
      shading: THREE.SmoothShading,
      reflectivity: 1,
      envMap: textureCube,
      overdraw: true
    }) 
    var mesh = new THREE.Mesh(geometry, material);
    mesh.position.set(0, 0, 0);
    mesh.scale.set(40, 40, 40);
    scene.add(mesh);
  });
}

function drawInlay(position, color){
  if(position === "top"){
    var rotation = 3.142;
  }else{
    var rotation = 0;
  }

  // console.log(position, color);
  
  if(color === "B"){
    var loaderInlay = new THREE.JSONLoader();
    loaderInlay.load('./'+ringSize+'-inlay.js', function(geometry) {
      var material = new THREE.MeshLambertMaterial({
        color: new THREE.Color(0x000000),
        specular: new THREE.Color(0x000000),
        shininess: 5,
        shading: THREE.SmoothShading,
        reflectivity: 1
      });
      var mesh = new THREE.Mesh(geometry, material);
      mesh.position.set(0, 0, 0);
      mesh.scale.set(40, 40, 40);
      mesh.rotation.set(rotation, 0, 0);
      scene.add(mesh);
    });
  }
  if(color === "T"){
    var loaderInlay = new THREE.JSONLoader();
    loaderInlay.load('./inlayUV.js', function(geometry) {
      var material = new THREE.MeshLambertMaterial({
        color: new THREE.Color(0xd3d3d3),
        specular: new THREE.Color(0xffffff),
        shininess: 200,
        shading: THREE.SmoothShading,
        reflectivity: 1,
        ambient: new THREE.Color(0xffffff),
        overdraw: true,
        map: THREE.ImageUtils.loadTexture('./inlayUV.png')
      });
  
      var mesh = new THREE.Mesh(geometry, material);
      mesh.position.set(0, 0, 0);
      mesh.scale.set(40, 40, 40);
      mesh.rotation.set(rotation, 0, 0);
      scene.add(mesh);
    });

    // Bottom Inlay Cover (Transparent)
    var loaderInlay = new THREE.JSONLoader();
    loaderInlay.load('./'+ringSize+'-inlay.js', function(geometry) {
      var material = new THREE.MeshLambertMaterial({
        color: new THREE.Color(0x000000),
        specular: new THREE.Color(0x000000),
        shininess: 1,
        shading: THREE.SmoothShading,
        reflectivity: 1,
        transparent: true,
        opacity:0.7
      })
      var mesh = new THREE.Mesh(geometry, material);
      mesh.position.set(0, 0, 0);
      mesh.scale.set(40, 40, 40);
      mesh.rotation.set(rotation, 0, 0);
      scene.add(mesh);
    });
  }
}
</script>
</html>
